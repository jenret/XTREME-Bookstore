<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Staatliches&family=Yantramanav&display=swap" rel="stylesheet">
    <meta charset="UTF-8">
    <title>XtremeBookStore</title>
    <script type="text/javascript">
        //this page would only show books available
        //keep track of what store the book is available
        //if admin, show how well the stores are doing, show sales etc.

        var authHeaderValue = null;
        var username = null;
        var password = null;

        //this is the function for the login
        function login() {
            username = document.getElementById('txtUsername').value;
            password = document.getElementById('txtPassword').value;
            authHeaderValue = "Basic " + btoa(username + ":" + password);
            var form = document.getElementById("receiptForm");

            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("GET", "/login");
            xmlHttp.setRequestHeader('Authorization', authHeaderValue);
            xmlHttp.onreadystatechange = function () {
                if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                    console.log("LOGIN SUCCESS");
                    //stop showing login
                    toggleLogin();
                    form.style.display = "block";
                    //show logout and welcome message
                    //save info for the session
                    userStorage(username, password);
                } else if (this.readyState == XMLHttpRequest.DONE && this.status == 401) {
                    document.getElementById("errorMsg").innerHTML = "Invalid Username or Password";
                    //keep showing login
                }
            }
            xmlHttp.send();
            username = document.getElementById("txtUsername").value = "";
            password = document.getElementById("txtPassword").value = "";
        }

        //this is an example function that shows and hides elements
        // function myFunction() {
        //     var x = document.getElementById("myDIV");
        //     if (x.style.display === "none") {
        //         x.style.display = "block";
        //     } else {
        //         x.style.display = "none";
        //     }
        // }

        function toggleLogin() {
            var loginForm = document.getElementById("login");
            var logoutBtn = document.getElementById("logout");
            var receiptForm = document.getElementById("receiptForm");
            var bookArea = document.getElementById("bookArea");
            var graphArea = document.getElementById("graphArea");

            if (loginForm.style.display === "none") {
                //show login
                loginForm.style.display = "block";
                logoutBtn.style.display = "none";
                receiptForm.style.display = "none";
                bookArea.style.display = "none";
                graphArea.style.display = "none";
            } else {
                //hide login
                loginForm.style.display = "none";
                logoutBtn.style.display = "inline-block";
                receiptForm.style.display = "block";
                bookArea.style.display = "block";
                graphArea.style.display = "block";
            }
        }

        //storage for username and password
        //session based
        function userStorage(strUsername, strPassword) {
            sessionStorage.setItem("username", strUsername);
            sessionStorage.setItem("password", strPassword);
        }

        //addBook finally works
        function addBook() {
            var ISBN = document.getElementById("ISBN").value;
            var title = document.getElementById("title").value;
            var author = document.getElementById("author").value;
            var publish = document.getElementById("publishDate").value;
            var edition = document.getElementById("edition").value;
            var price = document.getElementById("price").value;
            var object = {
                "ISBN": ISBN, //strings work fine
                "title": title, //string
                "author": author, //int works fine
                "publishDate": publish, //SQL date
                "edition": edition, //int
                "purchasePrice": price //double
            }
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("POST", "http://localhost:8080/book/create");
            xmlHttp.setRequestHeader("Content-Type", "application/json"); //sends json
            xmlHttp.setRequestHeader("Authorization", authHeaderValue); //put auth header into request header
            xmlHttp.onreadystatechange = function () {
                console.log("Ready state "+ this.status);
                if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                    console.log("Successfully posted");
                    getAllBooks();
                }
            }
            xmlHttp.send(JSON.stringify(object));
            var ISBN = document.getElementById("ISBN").value = "";
            var title = document.getElementById("title").value = "";
            var author = document.getElementById("author").value = "";
            var publish = document.getElementById("publishDate").value = "";
            var edition = document.getElementById("edition").value = "";
            var price = document.getElementById("price").value = "";
        }

        //all good
        function getAllBooks() {
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                    var objects = JSON.parse(this.responseText);
                    renderBooks(objects);
                }
            }
            xmlHttp.open("GET", "http://localhost:8080/book/findAll", true);
            xmlHttp.send();
        }

        //works good
        function renderBooks(books) {
            var bookList = document.getElementById("bookList");
            bookList.innerHTML = "";
            var bookHTML = ""
            bookHTML += "<table><tr>" +
                "<th>" + "ISBN" + "</th>" +
                "<th>" + "Title" + "</th>" +
                "<th>" + "Author ID" + "</th>" +
                "<th>" + "Author Name" + "</th>" +
                "<th>" + "Publish Date" + "</th>" +
                "<th>" + "Purchase Price" + "</th>" +
                "</tr> "
            for (var object of books) {
                bookHTML += "<tr>" +
                    "<td>" + object.ISBN + "</td>" +
                    "<td>" + object.title + "</td>" +
                    "<td>" + object.author + "</td>" +
                    "<td>" + object.authorName + "</td>" +
                    "<td>" + object.publishDate + "</td>" +
                    "<td>" + "$" + object.purchasePrice + "</td>"
                bookList.innerHTML = bookHTML;
            }
        }

        function sendBackReceipt() {
            var ISBN = document.getElementById("ISBN").value;
            var price = document.getElementById("price").value;
            var object = {
                "bookISBN": ISBN,
                "salePrice": price
            }
            var xmlHttp = new XMLHttpRequest();
            xmlHttp.open("POST", "http://localhost:8080/receipts");
            xmlHttp.setRequestHeader("Content-Type", "application/json"); //sends json
            xmlHttp.setRequestHeader("Authorization", authHeaderValue); //put auth header into request header
            xmlHttp.onreadystatechange = function () {
                console.log("Ready state ", this.status);
                if (this.readyState == XMLHttpRequest.DONE && this.status == 200) {
                    console.log("Successfully posted");
                    getAllBooks();
                }
            }
            xmlHttp.send(JSON.stringify(object));
            var ISBN = document.getElementById("ISBN").value = "";
            var price = document.getElementById("price").value = "";
        }

        window.onload = function () {
            var form = document.getElementById("receiptForm");
            form.style.display = "none";
            getAllBooks();
        }


    </script>
</head>
<nav>

</nav>
<body>
<h1>Xtreme Bookstore</h1>

<div id="login" class="login">
    <h2>Login</h2>
    <label>Username</label>
    <input type="text" id="txtUsername">
    <br/>
    <label>Password</label>
    <input type="password" id="txtPassword">
    <br/>
    <button onclick="login();">Login</button>
    <br/>
    <p id="errorMsg"></p>
</div>
<div id="logout" class="logout">
    <button class="logoutBtn" type="submit" onclick="toggleLogin()">Logout</button>
</div>
<br>
<div id="handleError"></div>
<br>
<div id="receiptForm" class="receiptForm">
<!-- Only require ISBN and price for the Add Sale-->
    <label>ISBN: </label>
    <input type="text" id="ISBN" required/>
    <br/>
    <label>Title: </label>
    <input type="text" id="title"/>
    <br/>
    <label>Author ID: </label>
    <input type="text" id="author"/>
    <br/>
    <label>Publish Date: </label>
    <input type="text" id="publishDate" placeholder="YYYY-MM-DD"/>
    <br/>
    <label>Edition: </label>
    <input type="text" id="edition"/>
    <br/>
    <label>Price: </label>
    <input type="text" id="price" required/>
    <br/>
    <label>Store ID: </label>
    <input type="number">
    <br/>
    <button onclick="sendBackReceipt();">Add Sale</button>
    <button onclick="addBook();">Add Book</button>
</div>
<br>
<div id="graphArea" class="graphArea">
    <div id="monthlyConsumable"></div>
    <div id="monthlyCustomer"></div>
    <div id="monthlySales"></div>
</div>
<br>
<div id="bookArea" class="bookArea">
    <ul id="bookList"></ul>
</div>
</body>
</html>